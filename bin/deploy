#!/bin/bash

set -e
TAG=$(echo $CI_COMMIT_ID | cut -c1-8)
CONTAINER_IMAGE=gcr.io/$GOOGLE_PROJECT_ID/$CONTAINER_NAME

echo "Authenticating"
codeship_google authenticate

echo "Setting default timezone $DEFAULT_ZONE"
gcloud config set compute/zone $DEFAULT_ZONE

echo "Setting default project $GOOGLE_PROJECT_ID"
gcloud config set project $GOOGLE_PROJECT_ID


# || die "unable to authenticate service account for gcloud"

if [ ! $# -eq 0 ]; then
	case "$1" in
		--create | -c)
      echo "Creating $CONTAINER_CLUSTER cluster."
			. bin/create-cluster
			exit
			;;
		--remove | -r)
      gcloud container clusters get-credentials $CONTAINER_CLUSTER
      echo "Removing $CONTAINER_CLUSTER cluster."
      . bin/remove-cluster
			exit
			;;
	esac
else
  gcloud container clusters get-credentials $CONTAINER_CLUSTER
  echo "Updating $CONTAINER_NAME service to $CONTAINER_NAME=$CONTAINER_IMAGE:$TAG"
  kubectl set image deployment/$CONTAINER_NAME $CONTAINER_NAME=$CONTAINER_IMAGE:$TAG
fi
